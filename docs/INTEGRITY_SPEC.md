# AAPM Cryptographic Integrity Specification

**Version**: 1.0
**Date**: 2026-01-06

---

## 1. Overview

This document specifies the cryptographic mechanisms used by the **Agent Activity & Permission Monitor (AAPM)** to ensure the integrity, verifiability, and non-repudiation of AI agent activity logs. The core principle is to create a tamper-evident, append-only ledger of events that can be independently verified offline.

This is achieved through a combination of:
- **Event Hashing**: Creating a unique, deterministic fingerprint of each event.
- **Hash Chaining**: Linking events together sequentially, similar to a blockchain, to prevent reordering or removal.
- **Batch Signing**: Periodically signing the root of the event chain with an Ed25519 key to provide non-repudiation.
- **Proof Export**: Bundling all necessary cryptographic data into a self-contained JSON file for offline verification.

## 2. Hashing and Chaining Process

The integrity of the event log is built upon two fundamental hashing operations: **event hashing** and **chain hashing**.

### 2.1. Event Hash

Each event ingested by AAPM is first converted into a canonical JSON string. This process ensures a deterministic output by sorting keys and removing whitespace. The canonical string is then hashed using **SHA-256** to produce the `event_hash`.

> **Canonicalization**: `json.dumps(event, sort_keys=True, separators=(",", ":"))`

> **Hashing**: `event_hash = SHA-256(canonical_json)`

This `event_hash` serves as a unique fingerprint of the event content.

### 2.2. Chain Hash

To create a sequential, tamper-evident log, each event is cryptographically linked to the previous one. This is done by computing a `chain_hash`.

The `chain_hash` is calculated by concatenating the current event's `event_hash` with the `chain_hash` of the *previous* event, and then hashing the result with **SHA-256**.

> **Chaining**: `chain_hash = SHA-256(event_hash + prev_chain_hash)`

| Field | Description |
|---|---|
| `event_hash` | The SHA-256 hash of the current event. |
| `prev_chain_hash` | The `chain_hash` of the immediately preceding event in the sequence. |
| `chain_hash` | The resulting hash that links the current event to the previous one. |

For the very first event of an agent (the "genesis event"), the `prev_chain_hash` is a zero-filled string: `"0" * 64`.

This structure ensures that any modification, reordering, or deletion of an event will break the chain, as the subsequent `chain_hash` values will no longer match.

## 3. Signature Generation and Verification

While the hash chain ensures integrity, digital signatures provide **non-repudiation**, proving that the event log was generated by a trusted source (the AAPM system).

### 3.1. Batch Root Hash

Instead of signing every single event, AAPM signs batches of events to improve efficiency. This is done by computing a **batch root hash**, which is a Merkle-like root of all the `chain_hash` values in a given proof export.

> **Batching**: `batch_root_hash = SHA-256(chain_hash_1 || chain_hash_2 || ... || chain_hash_n)`

This single hash serves as a cryptographic summary of the entire event chain within the proof.

### 3.2. Signature Generation

The `batch_root_hash` is signed using the organization's currently active **Ed25519** private key. Ed25519 is chosen for its high performance and strong security guarantees.

The signature, along with the `key_id` used for signing, is included in the exported proof bundle.

### 3.3. Signature Verification

Verification is performed by:
1. Re-computing the `batch_root_hash` from the events in the proof.
2. Retrieving the `public_key` from the proof bundle.
3. Using the Ed25519 `verify` function with the public key, the re-computed `batch_root_hash`, and the provided `signature`.

If the verification is successful, it proves that the event log has not been tampered with and was signed by the legitimate key holder.

## 4. Proof Export Schema

The cryptographic proof is exported as a JSON file. This file is self-contained and includes all information necessary for offline verification.

| Top-Level Field | Type | Description |
|---|---|---|
| `version` | String | The version of the proof schema (e.g., "1.0"). |
| `proof_type` | String | Always "aapm_chain_proof". |
| `org_id` | String | The organization ID. |
| `agent_id` | String | The agent ID. |
| `generated_at` | String | ISO 8601 timestamp of when the proof was generated. |
| `event_count` | Integer | The number of events included in the proof. |
| `events` | Array | An array of event objects (see below). |
| `batch_root_hash` | String | The SHA-256 root hash of the entire event chain in this proof. |
| `signature` | Object | The digital signature object (see below). |
| `public_key` | String | The PEM-encoded Ed25519 public key for verifying the signature. |
| `verification` | Object | Instructions for how to verify the proof. |

### 4.1. Event Object Schema

| Field | Type | Description |
|---|---|---|
| `id` | String | The unique ID of the event. |
| `event_type` | String | The type of the event (e.g., "tool_call"). |
| `timestamp` | String | ISO 8601 timestamp of the event. |
| `event_hash` | String | The SHA-256 hash of the event content. |
| `chain_hash` | String | The SHA-256 hash linking this event to the previous one. |
| `prev_chain_hash` | String | The `chain_hash` of the previous event. |

### 4.2. Signature Object Schema

| Field | Type | Description |
|---|---|---|
| `value` | String | The hex-encoded Ed25519 signature. |
| `algorithm` | String | The signature algorithm used (e.g., "Ed25519"). |
| `key_id` | String | The ID of the key used for signing. |
| `signed_at` | String | ISO 8601 timestamp of when the signature was created. |

---

This specification provides a robust framework for creating and verifying tamper-evident audit trails, forming the foundation of trust in the AAPM platform.
